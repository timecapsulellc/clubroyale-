rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // ============ USER PROFILES ============
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow users to update their own profile AND diamond balance
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if false;
      
      // Friends subcollection
      match /friends/{friendId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // Achievements subcollection
      match /achievements/{achievementId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated(); // Server creates, but allow for testing
        allow update: if false;
        allow delete: if false;
      }
      
      // Transactions subcollection
      match /transactions/{transactionId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ============ STORIES ============
    
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Profiles collection (used by profile_service.dart)
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if false;
    }
    
    // Wallets collection for diamond balances (legacy - see /wallets below)
    // REMOVED DUPLICATE: Wallet access is controlled in lines 237-240
    // match /wallets/{userId} {
    //   allow read: if isAuthenticated();
    //   allow create: if isAuthenticated();
    //   allow update: if isAuthenticated() && isOwner(userId);
    // }
    
    // ============ GAMES (ROOMS) ============
    // Main collection for game rooms - used by lobby_service
    
    match /games/{gameId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // SECURITY: Only host or participants can update/delete
      allow update: if isAuthenticated() && 
        (resource.data.hostId == request.auth.uid || 
         request.auth.uid in resource.data.playerIds);
      allow delete: if isAuthenticated() && 
        resource.data.hostId == request.auth.uid;
      
      // Chat subcollection
      match /chat/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if false;
      }
      
      // Typing indicators
      match /typing/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ============ MATCHES ============
    // Alternative collection name used by some services
    
    match /matches/{matchId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // SECURITY: Only host or participants can update/delete
      allow update: if isAuthenticated() && 
        (resource.data.hostId == request.auth.uid || 
         request.auth.uid in resource.data.playerIds);
      allow delete: if isAuthenticated() && 
        resource.data.hostId == request.auth.uid;
    }
    
    // ============ INVITES ============
    
    match /invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // ============ DIAMONDS ============
    

    
    match /diamond_spending/{spendId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ REFERRALS ============
    
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ CHAT ============
    
    match /chat/{roomId}/messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // ============ CHATS (Social DMs) ============
    // Main chats collection for social messaging
    
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ============ CONVERSATIONS (DMs) ============
    
    match /conversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ============ MATCHMAKING QUEUE ============
    
    match /matchmaking_queue/{queueId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ GAME INVITES ============
    
    match /game_invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // ============ SIGNALING (WebRTC) ============
    
    match /signaling/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /{document=**} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ============ GAME ROOMS (Signaling) ============
    // Used by SignalingService for WebRTC
    
    match /game_rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /webrtc/signaling {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
        
        match /offers/{offerId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
        
        match /answers/{answerId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
        
        match /candidates/{candidateId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }
    }

    match /voice_rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ WALLETS ============
    
    match /wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============ PROFILES ============
    
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // ============ LEDGER ============
    
    match /ledger/{gameId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============ AUDIT LOGS (Server-side only) ============
    
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_game_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============ FLAGGED USERS ============
    
    match /flaggedUsers/{userId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============ PURCHASES ============
    
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /purchase_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============ CLUBS ============
    
    match /clubs/{clubId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid);
      
      match /members/{memberId} {
        allow read: if isAuthenticated();
        // Allow members to join/leave (create/delete their own doc) or update their stats
        allow write: if isAuthenticated();
      }
      
      match /activity/{activityId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated(); // For likes
        allow delete: if false;
      }
    }
    
    match /club_invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ TRANSACTIONS ============
    
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }

    // ============ TOURNAMENTS ============
    
    match /tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin(); // Only admins can create tournaments
      allow update: if isAdmin(); // Only admins can update
      allow delete: if false;

      match /participants/{participantId} {
        allow read: if isAuthenticated();
        // Allow users to join (create their participant doc)
        allow create: if isAuthenticated() && (request.auth.uid == participantId);
        allow update: if isAuthenticated() && (request.auth.uid == participantId);
        allow delete: if false;
      }
    }

    // ============ ACTIVITY FEED ============
    
    match /feeds/{userId}/items/{itemId} {
       allow read: if isAuthenticated() && (request.auth.uid == userId);
       allow create: if isAuthenticated(); // Server or other users trigger feed items
       allow update: if false;
       allow delete: if false;
    }
    
    match /activities/{activityId} {
       allow read: if isAuthenticated();
       allow create: if isAuthenticated();
       allow update: if isAuthenticated();
    }

    match /activity_feed/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); // For likes
      allow delete: if false;
    }
    
    // ============ DIAMOND ECONOMY ============
    
    // Diamond rewards - track claimed rewards
    match /diamond_rewards/{rewardId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if false; // Only Cloud Functions can create
      allow update: if false;
      allow delete: if false;
    }
    
    // Diamond grant requests - admin only
    match /diamond_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Admins only (checked in code)
      allow update: if isAuthenticated(); // Admins only (checked in code)
      allow delete: if false;
    }
    
    // Diamond P2P transfers
    match /diamond_transfers/{transferId} {
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow delete: if false;
    }
    
    // Admin support chats
    match /admin_chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // Admins collection
    match /admins/{adminEmail} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions or manual setup
    }
    
    // Referrals
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    // ============ REPLAYS ============
    
    match /replays/{replayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Should ideally be server-side, but client upload common for mvp
      allow update: if false;
      allow delete: if false;
    }

    // ============ PROFILES SUBCOLLECTIONS ============

    match /profiles/{userId}/following/{followingId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(userId);
    }
    
    match /profiles/{userId}/followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated(); // Others write to this when they follow
    }
    
    // ============ MISC SERVICES ============
    
    match /feedback/{feedbackId} {
        allow create: if isAuthenticated();
        allow read: if isAdmin();
    }
    
    match /presence/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(userId);
    }
  }
}
