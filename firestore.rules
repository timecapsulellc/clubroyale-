rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // Check if user is a player in a match
    function isPlayerInMatch(matchData) {
      return request.auth.uid in matchData.players.keys();
    }
    
    // Check if user is host of a match
    function isMatchHost(matchData) {
      return request.auth.uid == matchData.hostId;
    }
    
    // Validate diamond balance is non-negative
    function hasValidBalance(data) {
      return data.diamonds >= 0;
    }
    
    // ============ USER PROFILES ============
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && hasValidBalance(request.resource.data);
      allow delete: if false; // Soft delete only
    }
    
    // ============ MATCHES (GAME ROOMS) ============
    
    match /matches/{matchId} {
      // Anyone authenticated can read active matches
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create a match (they become host)
      allow create: if isAuthenticated() && 
        request.resource.data.hostId == request.auth.uid;
      
      // Only players can update match state
      allow update: if isAuthenticated() && 
        (isPlayerInMatch(resource.data) || isMatchHost(resource.data));
      
      // Only host can delete (close room)
      allow delete: if isAuthenticated() && isMatchHost(resource.data);
    }
    
    // ============ INVITES ============
    
    match /invites/{inviteId} {
      // Anyone can read invites (needed for validation)
      allow read: if isAuthenticated();
      
      // Only host can create invites for their room
      allow create: if isAuthenticated() && 
        request.resource.data.hostId == request.auth.uid;
      
      // Track invite usage
      allow update: if isAuthenticated();
      
      allow delete: if false; // Keep for audit
    }
    
    // ============ WALLETS & DIAMONDS ============
    
    match /wallets/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && 
        request.resource.data.balance >= 0;
      allow delete: if false;
    }
    
    // ============ PURCHASES (Server-side only) ============
    
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      allow write: if false; // RevenueCat webhook only
    }
    
    match /purchase_logs/{logId} {
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      allow write: if false; // Server-side only
    }
    
    match /diamond_spending/{spendId} {
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      allow write: if false; // Server-side only
    }
    
    // ============ AUDIT LOGS (Read-only) ============
    
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Server-side only
    }
    
    match /audit_game_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_deals/{dealId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_moves/{moveId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_suspicious/{suspiciousId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_player_stats/{userId} {
      // Players can see their own stats
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    // ============ FLAGGED USERS (Admin only) ============
    
    match /flaggedUsers/{userId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============ LEGACY COLLECTIONS ============
    
    match /games/{gameId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.scores.keys();
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.scores.keys();
    }
    
    match /ledger/{gameId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.fromUserId ||
         request.auth.uid == resource.data.toUserId);
      allow write: if false;
    }
  }
}
