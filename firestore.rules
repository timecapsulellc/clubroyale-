rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // ============ USER PROFILES ============
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow users to update their own profile AND diamond balance
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if false;
    }
    
    // Wallets collection for diamond balances
    match /wallets/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isOwner(userId);
    }
    
    // ============ GAMES (ROOMS) ============
    // Main collection for game rooms - used by lobby_service
    
    match /games/{gameId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ MATCHES ============
    // Alternative collection name used by some services
    
    match /matches/{matchId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ INVITES ============
    
    match /invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // ============ DIAMONDS ============
    
    match /diamond_rewards/{rewardId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    match /diamond_spending/{spendId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ REFERRALS ============
    
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ CHAT ============
    
    match /chat/{roomId}/messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // ============ CONVERSATIONS (DMs) ============
    
    match /conversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ============ MATCHMAKING QUEUE ============
    
    match /matchmaking_queue/{queueId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============ SIGNALING (WebRTC) ============
    
    match /signaling/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /{document=**} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ============ WALLETS ============
    
    match /wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ============ PROFILES ============
    
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // ============ LEDGER ============
    
    match /ledger/{gameId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============ AUDIT LOGS (Server-side only) ============
    
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_game_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============ FLAGGED USERS ============
    
    match /flaggedUsers/{userId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============ PURCHASES ============
    
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /purchase_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ============ TRANSACTIONS ============
    
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ DIAMOND ECONOMY ============
    
    // Diamond rewards - track claimed rewards
    match /diamond_rewards/{rewardId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if false; // Only Cloud Functions can create
      allow update: if false;
      allow delete: if false;
    }
    
    // Diamond grant requests - admin only
    match /diamond_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Admins only (checked in code)
      allow update: if isAuthenticated(); // Admins only (checked in code)
      allow delete: if false;
    }
    
    // Diamond P2P transfers
    match /diamond_transfers/{transferId} {
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow delete: if false;
    }
    
    // Admin support chats
    match /admin_chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // Admins collection
    match /admins/{adminEmail} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions or manual setup
    }
    
    // Referrals
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
  }
}
